# UI - Пользовательский интерфейс

## Назначение
Содержит компоненты пользовательского интерфейса для отображения игровой информации. Все UI компоненты подписываются на события от игровых систем и обновляются автоматически.

## Основные компоненты

### IUIElement
- **Назначение**: Интерфейс для UI элементов, которые могут быть автоматически настроены
- **Ответственность**:
  - Унификация API для настройки UI компонентов
  - Замена рефлексии на типобезопасные методы
  - Обеспечение консистентности в настройке UI
- **Методы**:
  - `SetupUI(Image image)` - настройка Image компонента

### HealthBar
- **Назначение**: Отображение полоски здоровья игрока
- **Ответственность**:
  - Подписка на событие `OnHealthChanged` от `PlayerHealth`
  - Визуализация текущего уровня здоровья через `Image.fillAmount`
  - Плавное изменение заполнения и цвета
  - Динамический цвет в зависимости от процента здоровья (зеленый → желтый → красный)
- **Настройки**:
  - `fillImage` - ссылка на Image компонент (находится автоматически если не назначена)
  - `healthyColor` - цвет при полном здоровье (по умолчанию зеленый)
  - `midHealthColor` - цвет при среднем здоровье (по умолчанию желтый)
  - `lowHealthColor` - цвет при низком здоровье (по умолчанию красный)
  - `lowHealthThreshold` - порог низкого здоровья (по умолчанию 0.3)
  - `midHealthThreshold` - порог среднего здоровья (по умолчанию 0.6)
  - `smoothTransition` - плавное изменение заполнения
  - `transitionSpeed` - скорость анимации

### ArmorBar
- **Назначение**: Отображение полоски брони игрока
- **Ответственность**:
  - Подписка на событие `OnArmorChanged` от `PlayerHealth`
  - Визуализация текущего уровня брони через `Image.fillAmount`
  - Автоматическое скрытие когда броня = 0
  - Плавное появление/исчезновение через `CanvasGroup.alpha`
  - Динамический цвет в зависимости от процента брони
- **Настройки**:
  - `fillImage` - ссылка на Image компонент (находится автоматически если не назначена)
  - `canvasGroup` - ссылка на CanvasGroup компонент (создается автоматически если отсутствует)
  - `armorColor` - цвет при хорошей броне (по умолчанию синий)
  - `lowArmorColor` - цвет при низкой броне (по умолчанию серый)
  - `lowArmorThreshold` - порог низкой брони (по умолчанию 0.3)
  - `hideWhenEmpty` - скрывать ли бар когда броня = 0
  - `smoothTransition` - плавное изменение заполнения
  - `transitionSpeed` - скорость анимации заполнения
  - `fadeSpeed` - скорость появления/исчезновения через alpha

### Crosshair
- **Назначение**: Отображение прицела (крестика) по центру экрана
- **Ответственность**:
  - Автоматическое создание 4 линий (верх, низ, лево, право)
  - Скрытие при паузе/GameOver через подписку на GameManager
  - Плавное появление/исчезновение через CanvasGroup.alpha
- **Настройки**:
  - `topLine`, `bottomLine`, `leftLine`, `rightLine` - ссылки на Image компоненты (создаются автоматически)
  - `canvasGroup` - ссылка на CanvasGroup компонент (создается автоматически если отсутствует)
  - `lineLength` - длина линий прицела
  - `lineWidth` - ширина линий прицела
  - `lineGap` - расстояние от центра до линий
  - `crosshairColor` - цвет прицела
  - `fadeSpeed` - скорость появления/исчезновения

### WeaponSpriteDisplay
- **Назначение**: Отображение и анимация спрайтов оружия в стиле DOOM
- **Ответственность**:
  - Подписка на события `WeaponManager` (смена оружия, стрельба, перезарядка)
  - Анимация спрайтов оружия (idle, fire, reload)
  - Автоматическое переключение спрайтов при смене оружия
  - Отображение спрайта пустой обоймы
- **Настройки**:
  - `weaponImage` - ссылка на Image компонент (находится автоматически если не назначена)
  - `weaponSpriteData` - массив ScriptableObject'ов с данными спрайтов для каждого оружия
  - `playIdleAnimation` - включить ли idle анимацию (циклическая)
  - `playFireAnimation` - включить ли анимацию выстрела (один раз)
  - `playReloadAnimation` - включить ли анимацию перезарядки (один раз)
- **Интеграция**: Автоматически подписывается на `WeaponManager.OnWeaponChanged`, `OnWeaponFired`, `OnWeaponReloaded`

### WeaponSpriteData (ScriptableObject)
- **Назначение**: Хранит данные анимации спрайтов для конкретного оружия
- **Создание**: `Assets → Create → WAD64 → Weapon Sprite Data`
- **Настройки**:
  - `weaponName` - название оружия (должно совпадать с `Weapon.WeaponName`)
  - `idleSprites` - массив спрайтов для idle анимации (циклическая)
  - `idleAnimationSpeed` - скорость idle анимации (кадров в секунду)
  - `fireSprites` - массив спрайтов для анимации выстрела (проигрывается один раз, **скорость зависит от fireRate оружия**)
  - `reloadSprites` - массив спрайтов для анимации перезарядки (проигрывается один раз, **синхронизируется с реальным временем перезарядки оружия**)
  - `emptySprite` - спрайт для пустой обоймы (опционально)

## Система меню (Menu/)

Система меню управляет главным меню, меню паузы и настройками игры.

### MenuManager
- **Назначение**: Центральный менеджер всех меню (паузы, настроек, главного меню)
- **Ответственность**:
  - Координация между различными меню
  - Управление показом/скрытием меню
  - Отслеживание состояния открытых меню
  - Обработка переключения между меню паузы и настроек
- **Методы**:
  - `ShowPauseMenu()` / `HidePauseMenu()` - управление меню паузы
  - `ShowSettingsMenu(origin)` / `HideSettingsMenu()` - управление меню настроек
  - `HideAllMenus()` - закрытие всех меню (используется при возобновлении игры)
  - `IsSettingsOpen()` / `IsPauseMenuOpen()` / `IsAnyMenuOpen()` - проверка состояния меню
- **Особенности**: Singleton паттерн, автоматическое восстановление меню паузы после закрытия настроек

### PauseMenuController
- **Назначение**: Управление меню паузы в игровой сцене
- **Ответственность**:
  - Показ/скрытие панели паузы
  - Управление курсором (блокировка/разблокировка)
  - Обработка кнопок: Continue, Settings, Main Menu
- **Методы**:
  - `Show()` / `Hide()` - показ/скрытие меню с управлением курсором
  - `HidePanelOnly()` - скрытие только панели без блокировки курсора (для перехода в Settings)
  - `ResumeGame()` - возобновление игры через GameManager
  - `OpenSettings()` - открытие меню настроек
  - `GoToMainMenu()` - переход в главное меню
- **Настройки**:
  - `pausePanel` - ссылка на GameObject панели паузы
  - `mainMenuSceneName` - имя сцены главного меню

### SettingsMenuController
- **Назначение**: Управление меню настроек
- **Ответственность**:
  - Показ/скрытие панели настроек
  - Отслеживание источника открытия (MainMenu или PauseMenu)
  - Уведомление подписчиков о закрытии меню
- **Методы**:
  - `Open(origin)` - открытие меню настроек с указанием источника
  - `CloseSettings(notify)` - закрытие меню (с опциональным уведомлением)
  - `BackToPreviousMenu()` - альтернативное имя для кнопки "Назад"
- **События**:
  - `OnSettingsClosed` - вызывается при закрытии меню (если `notify = true`)
- **Настройки**:
  - `settingsPanel` - ссылка на GameObject панели настроек
- **Особенности**: При закрытии из PauseMenu автоматически возвращается в меню паузы

### MainMenuController
- **Назначение**: Управление главным меню
- **Ответственность**:
  - Обработка кнопок главного меню: Play, Settings, Quit
- **Методы**:
  - `PlayGame()` - загрузка игровой сцены
  - `OpenSettings()` - открытие меню настроек
  - `QuitGame()` - выход из игры (в редакторе останавливает Play Mode)
- **Настройки**:
  - `gameSceneName` - имя игровой сцены

### AudioSettings
- **Назначение**: Управление настройками аудио (master и music volume)
- **Ответственность**:
  - Управление громкостью master (через `AudioListener.volume`)
  - Управление громкостью музыки (через `MusicManager`)
  - Сохранение настроек в `SettingsData` и `PlayerPrefs`
  - Синхронизация слайдеров с текущими значениями
- **Методы для слайдеров**:
  - `UpdateVolumeFromSlider(float value)` / `UpdateVolumeFromSlider()` - установка master volume из слайдера
  - `UpdateMusicVolumeFromSlider(float value)` / `UpdateMusicVolumeFromSlider()` - установка music volume из слайдера
- **Настройки**:
  - `settingsData` - ссылка на ScriptableObject с настройками
  - `volumeSlider` - слайдер для master volume
  - `musicVolumeSlider` - слайдер для music volume
- **Интеграция**: Автоматически загружает сохраненные значения при старте и синхронизирует слайдеры при открытии

### SettingsData (ScriptableObject)
- **Назначение**: Хранение настроек игры
- **Создание**: `Assets → Create → WAD64 → Settings → Settings Data`
- **Поля**:
  - `MasterVolume` - общая громкость (0-1)
  - `MusicVolume` - громкость музыки (0-1)
- **Особенности**: Значения автоматически сохраняются при изменении через `AudioSettings`

## Принципы работы

1. **Инициализация**:
   - Все UI компоненты получают ссылку на `PlayerHealth` через `CoreReferences`
   - Автоматическая подписка на события в `Start()`
   - Автоматическая отписка в `OnDestroy()` для предотвращения утечек памяти
   - **UIInitializer** автоматически настраивает компоненты через публичные методы (без рефлексии)

2. **Обновление**:
   - UI компоненты реагируют только на события, не делают `Update()` запросы к PlayerHealth
   - Плавная анимация изменений через `Mathf.Lerp` в `Update()`
   - Автоматическое изменение цвета в зависимости от значения

3. **Визуальные особенности**:
   - **HealthBar**: меняет цвет от зеленого через желтый к красному
   - **ArmorBar**: плавно исчезает когда броня заканчивается
   - **Crosshair**: автоматически создается и центрируется, скрывается при паузе
   - **WeaponSpriteDisplay**: анимирует спрайты оружия в стиле DOOM, реагирует на события стрельбы
   - Оба бара поддерживают плавную анимацию изменений

4. **Архитектура**:
   - Все UI элементы реализуют интерфейс `IUIElement`
   - Публичный метод `SetupUI(Image image)` для настройки
   - Отсутствие рефлексии для лучшей производительности и безопасности типов
   - Компоненты автоматически находят нужные ссылки в `Awake()` если они не назначены в инспекторе

## Зависимости
- **Исходящие**: Player (PlayerHealth), Weapons (WeaponManager)
- **Входящие**: Core (CoreReferences), Managers (GameManager, MusicManager)
- **Unity компоненты**: UnityEngine.UI (Image, CanvasGroup, Slider)

## Интеграция в сцену

### Пример структуры Canvas:
```
Canvas
├── HealthBar (GameObject с компонентами: HealthBar, Image)
├── ArmorBar (GameObject с компонентами: ArmorBar, Image, CanvasGroup)
├── Crosshair (GameObject с компонентами: Crosshair, CanvasGroup)
│   ├── TopLine (Image)
│   ├── BottomLine (Image)
│   ├── LeftLine (Image)
│   └── RightLine (Image)
└── WeaponSpriteDisplay (GameObject с компонентами: WeaponSpriteDisplay, Image)
```

**Примечание**: 
- Image компонент находится прямо на GameObject HealthBar/ArmorBar/WeaponSpriteDisplay, дочерние объекты не требуются
- Crosshair автоматически создает дочерние Image компоненты для линий прицела

### Настройка компонентов:

1. **HealthBar**:
   - Добавить компонент `HealthBar` на GameObject с `Image`
   - UIInitializer автоматически настроит `Image Type` = `Filled` и `Fill Method` = `Vertical`
   - Поле `fillImage` устанавливается автоматически через `SetupUI()` (или находится в `Awake()`)
   - **Позицию и размер настраивайте вручную в Unity Editor через RectTransform**

2. **ArmorBar**:
   - Добавить компонент `ArmorBar` на GameObject с `Image`
   - UIInitializer автоматически настроит `Image Type` = `Filled` и `Fill Method` = `Vertical`
   - Поле `fillImage` и `canvasGroup` устанавливаются автоматически через `SetupUI()` (или находятся/создаются в `Awake()`)
   - Компонент `CanvasGroup` добавится автоматически если отсутствует (через `Awake()` или `SetupUI()`)
   - **Позицию и размер настраивайте вручную в Unity Editor через RectTransform**

3. **Crosshair**:
   - Добавить компонент `Crosshair` на GameObject с `CanvasGroup` в Canvas
   - Crosshair автоматически создаст дочерние Image компоненты для линий прицела
   - UIInitializer автоматически настроит компонент
   - **Позицию и размер настраивайте вручную в Unity Editor через RectTransform**

4. **WeaponSpriteDisplay**:
   - Создайте ScriptableObject для каждого оружия: `Assets → Create → WAD64 → Weapon Sprite Data`
   - Назовите их соответственно (например, `PistolSprites`, `ShotgunSprites`)
   - Заполните массивы спрайтов (idle, fire, reload) и настройте скорости анимации
   - Убедитесь, что `weaponName` в ScriptableObject совпадает с `WeaponName` в скрипте оружия
   - Добавьте компонент `WeaponSpriteDisplay` на GameObject с `Image` в Canvas
   - Перетащите созданные ScriptableObject'ы в массив `Weapon Sprite Data`
   - UIInitializer автоматически настроит `Image Type` = `Simple` и `Preserve Aspect` = `true`
   - **Позицию и размер настраивайте вручную в Unity Editor через RectTransform** (как для других UI элементов)

5. **Настройка позиции и размера в Unity Editor**:
   - Выберите GameObject с HealthBar/ArmorBar/WeaponSpriteDisplay
   - В компоненте **RectTransform** настройте:
     - **Position**: позицию элемента
     - **Size**: размер элемента  
     - **Anchor**: привязку к краям экрана
     - **Pivot**: точку поворота/масштабирования

6. **Ручная настройка** (альтернатива UIInitializer):
   ```csharp
   // Для HealthBar
   healthBar.SetupUI(healthImage);
   healthBar.SetPlayerHealth(playerHealth); // Для тестирования или ручной настройки
   
   // Для ArmorBar  
   armorBar.SetupUI(armorImage);
   armorBar.SetPlayerHealth(playerHealth); // Для тестирования или ручной настройки
   
   // Для WeaponSpriteDisplay
   weaponSpriteDisplay.SetupUI(weaponImage);
   weaponSpriteDisplay.SetWeaponSpriteData(spriteDataArray); // Установить данные спрайтов
   ```

## Примечания
- Все UI компоненты не требуют ручной привязки к игроку - они используют `CoreReferences`
- Компоненты безопасны к уничтожению игрока и автоматически отписываются от событий
- Цвета и пороги полностью настраиваются в инспекторе Unity
- Плавность анимаций можно отключить для ретро-стиля (instant updates)
- **Новая архитектура**: Отсутствие рефлексии, использование публичных методов и интерфейсов
- **Производительность**: Прямые вызовы методов вместо медленной рефлексии
- **Безопасность типов**: Ошибки настройки обнаруживаются на этапе компиляции

